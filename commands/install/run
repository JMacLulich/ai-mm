#!/usr/bin/env bash
#
# Install command for claude-mm-tool
#
# Installs the ai tool to ~/.local/bin with proper venv

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT="$(cd "$SCRIPT_DIR/../.." && pwd)"

usage() {
    cat <<EOF
Usage: ./run install [OPTIONS]

Install claude-mm-tool to ~/.local/bin

Options:
  --help    Show this help message

Note: Installer always checks for missing API keys during installation.
EOF
}

check_dependencies() {
    if ! command -v python3 &> /dev/null; then
        echo "Error: python3 is not installed" >&2
        exit 1
    fi

    # Check for venv module (often missing on minimal Debian/Ubuntu)
    if ! python3 -m venv --help &> /dev/null; then
        echo "Error: Python 'venv' module is missing." >&2
        echo "  On Ubuntu/Debian, please run: sudo apt install python3-venv" >&2
        exit 1
    fi
}

check_path() {
    local bin_dir="$HOME/.local/bin"
    if [[ ":$PATH:" != *":$bin_dir:"* ]]; then
        echo ""
        echo "‚ö†Ô∏è  Warning: $bin_dir is not in your PATH."
        echo "   To use the 'ai' command, add this to your ~/.bashrc or ~/.profile:"
        echo "     export PATH=\"$bin_dir:\$PATH\""
    fi
}

main() {
    check_dependencies
    cd "$ROOT"

    if [[ "${1:-}" == "--help" ]]; then
        usage
        exit 0
    fi

    echo "üì¶ Installing claude-mm-tool..."

    # Create ~/.local/bin if it doesn't exist
    mkdir -p "$HOME/.local/bin"

    # Create venv at ~/.local/venvs/ai
    local venv_dir="$HOME/.local/venvs/ai"

    if [[ ! -d "$venv_dir" ]]; then
        echo "üêç Creating Python virtual environment..."
        python3 -m venv "$venv_dir"
    fi

    # Install dependencies
    echo "üìö Installing dependencies..."
    "$venv_dir/bin/pip" install -q --upgrade pip
    "$venv_dir/bin/pip" install -q --upgrade -e "$ROOT"
    "$venv_dir/bin/pip" install -q --upgrade -e "$ROOT[dev]"

    # Copy ai script to ~/.local/bin with venv shebang
    echo "üîß Installing ai command..."
    local ai_bin="$HOME/.local/bin/ai"
    cp "$ROOT/bin/ai" "$ai_bin"

    # Update shebang to use venv Python
    sed -i.bak "1s|.*|#!$venv_dir/bin/python3|" "$ai_bin"
    rm "$ai_bin.bak"
    chmod +x "$ai_bin"

    # Install Carapace completion if .carapace spec exists
    if [[ -f "$ROOT/.carapace/ai.yaml" ]]; then
        echo "üéØ Installing shell completions..."
        mkdir -p "$HOME/.config/carapace/specs"
        cp "$ROOT/.carapace/ai.yaml" "$HOME/.config/carapace/specs/"
        echo "  ‚úì ai.yaml"
    fi

    # Install mm-review skill to ~/.claude
    if [[ -d "$ROOT/claude/skills/mm-review" ]]; then
        echo "üîß Installing mm-review skill..."
        # Remove existing symlink if present
        if [[ -L "$HOME/.claude/skills/mm-review" ]]; then
            rm "$HOME/.claude/skills/mm-review"
        fi
        mkdir -p "$HOME/.claude/skills/mm-review"
        cp "$ROOT/claude/skills/mm-review/skill.md" "$HOME/.claude/skills/mm-review/"
        echo "  ‚úì Skill installed to ~/.claude/skills/mm-review/"
    fi

    # Check API keys
    local config_dir="$HOME/.config/ai-mm"
    local env_file="$config_dir/env"

    # Migrate old configs if new config doesn't exist or is empty
    local old_config="$HOME/.config/claude-mm-tool/env"
    local system_config="$HOME/.config/system-playbooks/env"
    
    if [[ ! -f "$env_file" ]] && [[ -f "$old_config" ]]; then
        mkdir -p "$config_dir"
        cp "$old_config" "$env_file"
        chmod 600 "$env_file"
        echo "‚úì Migrated config from ~/.config/claude-mm-tool to ~/.config/ai-mm"
    elif [[ ! -f "$env_file" ]] && [[ -f "$system_config" ]]; then
        mkdir -p "$config_dir"
        # Extract relevant keys from system-playbooks
        grep -E "^(export )?(OPENAI|GOOGLE|ANTHROPIC)_API_KEY" "$system_config" 2>/dev/null > "$env_file" || true
        if [[ -s "$env_file" ]]; then
            chmod 600 "$env_file"
            echo "‚úì Migrated config from ~/.config/system-playbooks to ~/.config/ai-mm"
        fi
    fi

    mkdir -p "$config_dir"

    # If env file exists with real keys, don't touch it
    if [[ -f "$env_file" ]] && grep -qE "sk-(proj-)?[A-Za-z0-9]{10,}" "$env_file" 2>/dev/null; then
        echo ""
        echo "‚öôÔ∏è  API keys configured at: $env_file"
        echo "   Run 'ai config' to manage keys"
        echo ""
        return 0
    fi

    # Only prompt for keys if file doesn't exist
    echo ""
    echo "‚öôÔ∏è  Checking API keys..."

    local openai_key=""
    local google_key=""
    local anthropic_key=""

    echo ""
    read -p "Enter your OpenAI API key (or press Enter to skip): " openai_key
    read -p "Enter your Google AI API key (or press Enter to skip): " google_key
    read -p "Enter your Anthropic API key (optional, press Enter to skip): " anthropic_key

    # Write env file if we have at least one key
    if [[ -n "$openai_key" || -n "$google_key" || -n "$anthropic_key" ]]; then
        echo "# AI Tool API Keys" > "$env_file"
        if [[ -n "$openai_key" ]]; then
            echo "export OPENAI_API_KEY=\"$openai_key\"" >> "$env_file"
        fi
        if [[ -n "$google_key" ]]; then
            echo "export GOOGLE_AI_API_KEY=\"$google_key\"" >> "$env_file"
        fi
        if [[ -n "$anthropic_key" ]]; then
            echo "export ANTHROPIC_API_KEY=\"$anthropic_key\"" >> "$env_file"
        fi
        chmod 600 "$env_file"
        echo ""
        echo "‚úì API keys saved to $env_file"
    else
        echo ""
        echo "‚ö†Ô∏è  No API keys configured. Run 'ai config' to add them."
    fi

    echo ""
    echo "‚úÖ Installation complete!"
    echo ""
    echo "   Command: ai"
    echo "   Location: $ai_bin"
    echo "   Config: $config_dir"
    
    check_path
    
    echo ""
    echo "Try: ai --help"
}

main "$@"
